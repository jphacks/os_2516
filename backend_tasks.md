# リアル版格闘ゲーム - バックエンド開発タスク

## アプリ全体の必要なタスク

### 1. プロジェクト基盤
- [ ] Go サーバープロジェクトの初期化とディレクトリ構造作成
- [ ] Supabase データベースマイグレーション実装
- [ ] iOS プロジェクト基盤の構築（SwiftUI）
- [ ] 依存性注入コンテナの実装

### 2. 認証・ユーザー管理
- [ ] Apple Sign In認証機能（既に実装済み）
- [ ] ユーザープロフィール管理
- [ ] セッション管理

### 3. ゲームコア機能
- [ ] UWB位置検出システム
- [ ] 攻撃判定エンジン
- [ ] HP・魔素管理システム
- [ ] ゲームセッション管理
- [ ] リアルタイム通信（WebSocket）

### 4. ゲームメカニクス
- [ ] 詠唱機能付き攻撃システム
- [ ] 移動距離ベースの魔素回収
- [ ] 振動フィードバックシステム
- [ ] 裁定システム（妖精協会ルール）

### 5. UI/UX
- [ ] ゲーム画面（HP表示、攻撃ボタン、魔素バー）
- [ ] ロビー画面
- [ ] 散歩モード画面

## バックエンドAPIエンドポイント

### 認証エンドポイント（既に実装済み）
```
POST /auth/apple/signin    # Apple Sign In
POST /auth/refresh         # トークンリフレッシュ
POST /auth/logout          # ログアウト
```

### ゲームセッション管理
```
POST /api/sessions                    # ゲームセッション作成
GET  /api/sessions/{id}              # セッション情報取得
PUT  /api/sessions/{id}/join         # セッション参加
PUT  /api/sessions/{id}/leave        # セッション離脱
PUT  /api/sessions/{id}/start        # ゲーム開始
PUT  /api/sessions/{id}/end          # ゲーム終了
GET  /api/sessions/active            # アクティブセッション一覧
```

### プレイヤー管理
```
GET  /api/players/{id}               # プレイヤー情報取得
PUT  /api/players/{id}               # プレイヤー情報更新
GET  /api/players/{id}/stats         # プレイヤー統計取得
GET  /api/players/{id}/history       # ゲーム履歴取得
```

### ゲームアクション
```
POST /api/games/{sessionId}/attack   # 攻撃実行
POST /api/games/{sessionId}/position # 位置情報更新
POST /api/games/{sessionId}/mana     # 魔素回収
GET  /api/games/{sessionId}/state    # ゲーム状態取得
```

### リアルタイム通信
```
WebSocket /ws/game/{sessionId}       # ゲームセッション用WebSocket
WebSocket /ws/lobby                  # ロビー用WebSocket
```

### 散歩モード
```
POST /api/walk/start                 # 散歩開始
POST /api/walk/end                   # 散歩終了
POST /api/walk/collect               # 散歩魔素回収
GET  /api/walk/stats                 # 散歩統計取得
```

### 裁定システム
```
GET  /api/rules                      # 妖精協会ルール取得
POST /api/arbitration/report         # ルール違反報告
GET  /api/arbitration/status         # 裁定状況確認
```

## バックエンド担当者のタスク

### 優先度：高（MVP必須）

1. **データベーススキーマ拡張**
   - ゲームセッション、プレイヤー統計、ゲーム履歴テーブルの追加
   - 既存の認証テーブルとの整合性確保

2. **ドメインエンティティ実装**
   - `Player`, `GameSession`, `Position`, `AttackAction` エンティティ
   - ゲームルールと攻撃判定ロジック

3. **ゲームセッション管理API**
   - セッション作成・参加・離脱・開始・終了
   - セッション状態管理とバリデーション

4. **攻撃判定エンジン**
   - 位置情報ベースの攻撃判定ロジック
   - ダメージ計算とHP管理
   - 詠唱時間の検証

5. **WebSocket通信基盤**
   - リアルタイムゲーム状態同期
   - プレイヤー間の位置情報共有
   - 攻撃結果の即座な配信

### 優先度：中（重要機能）

6. **魔素回収システム**
   - 移動距離計算ロジック
   - 散歩モードでの魔素回収
   - 魔素消費と攻撃制限

7. **プレイヤー統計システム**
   - 勝敗記録、ゲーム履歴
   - レベル・経験値システム
   - ランキング機能

8. **裁定システム**
   - ルール違反検出
   - 自動裁定ロジック
   - 妖精協会ルール管理

### 優先度：低（追加機能）

9. **パフォーマンス最適化**
   - データベースクエリ最適化
   - WebSocket接続管理
   - キャッシュ戦略

10. **セキュリティ強化**
    - チート防止機能
    - 位置情報の整合性チェック
    - レート制限

## 技術スタック（バックエンド）

- **言語**: Go（既に選択済み）
- **フレームワーク**: 標準ライブラリ + gorilla/mux または gin
- **データベース**: PostgreSQL（Supabase）
- **リアルタイム通信**: gorilla/websocket
- **認証**: JWT + Apple Sign In（既に実装済み）
- **デプロイ**: GCP Cloud Run

## 開発順序の推奨

1. **データベーススキーマ設計・実装**
2. **ドメインエンティティとリポジトリ実装**
3. **ゲームセッション管理API**
4. **攻撃判定エンジン**
5. **WebSocket通信基盤**
6. **魔素回収システム**
7. **プレイヤー統計システム**
8. **裁定システム**

この順序で進めることで、MVP（最小実行可能製品）を早期に構築し、段階的に機能を追加していけます。

## 次のステップ

バックエンド担当として、まずはデータベーススキーマの拡張から始めることをお勧めします。既存の認証機能を活用しながら、ゲーム機能に必要なテーブルを追加していきましょう。
